# 实施计划: coh-noc-architecture

## 概述

本实施计划将 coh_noc 片上一致性互连网络的设计转换为一系列增量式的 SystemVerilog 实现任务。每个任务都建立在前一个任务的基础上，最终完成完整的系统集成。

## 任务

- [x] 1. 建立项目结构和核心接口定义
  - 创建 SystemVerilog 包和基础数据类型定义
  - 定义 CHI 协议相关的枚举和结构体
  - 建立接口定义文件
  - _需求: 2.1, 2.2_

- [x] 2. 实现基础数据结构和协议定义
  - [x] 2.1 实现 Flit 数据结构和 CHI 操作码
    - 定义 flit_t 结构体和 chi_opcode_e 枚举
    - 实现 Flit 打包和解包函数
    - _需求: 2.1, 2.2_

  - [x] 2.2 为 Flit 结构编写属性测试
    - **属性 4: 虚拟通道功能完整性**
    - **验证需求: Requirements 2.3, 2.4, 2.5, 2.6**

  - [x] 2.3 实现 Directory 状态结构
    - 定义 directory_entry_t 和相关状态枚举
    - 实现状态转换函数
    - _需求: 7.1, 7.2, 4.4_

  - [x] 2.4 为 Directory 状态编写属性测试
    - **属性 10: Directory 状态一致性**
    - **验证需求: Requirements 4.4, 7.1, 7.2, 7.3**

- [-] 3. 实现 XP 路由器核心功能
  - [x] 3.1 实现路由计算单元
    - 编写 X-Y 维序路由算法
    - 实现坐标到端口的映射逻辑
    - _需求: 1.2, 3.4_

  - [x] 3.2 为路由算法编写属性测试
    - **属性 2: X-Y 维序路由正确性**
    - **验证需求: Requirements 1.2, 3.4**

  - [x] 3.3 实现虚拟通道缓冲区管理
    - 创建独立的 VC FIFO 缓冲区
    - 实现缓冲区状态管理
    - _需求: 3.5, 8.3_

  - [x] 3.4 为 VC 缓冲区编写属性测试
    - **属性 7: 虚拟通道隔离性**
    - **验证需求: Requirements 3.5, 8.3**

  - [x] 3.5 实现信用流控机制
    - 编写信用计数器和流控逻辑
    - 实现背压信号处理
    - _需求: 3.2, 8.1, 8.2_

  - [x] 3.6 为流控机制编写属性测试
    - **属性 6: 信用流控机制**
    - **属性 8: 缓冲区背压机制**
    - **验证需求: Requirements 3.2, 8.1, 8.2, 8.4**

- [-] 4. 完成 XP 路由器集成
  - [x] 4.1 实现 XP 路由器顶层模块
    - 集成路由计算、缓冲区管理和流控
    - 实现仲裁器处理端口竞争
    - _需求: 3.1, 1.1_

  - [x] 4.2 为 XP 路由器编写综合属性测试
    - **属性 5: Flit 转发正确性**
    - **验证需求: Requirements 3.1**

  - [x] 4.3 编写 XP 路由器单元测试
    - 测试边界情况和错误条件
    - 验证端口竞争处理
    - _需求: 3.1, 3.3_

- [x] 5. 检查点 - 确保路由器功能正确
  - 确保所有测试通过，如有问题请询问用户

- [x] 6. 实现 2D Mesh 网络拓扑
  - [x] 6.1 创建网格连接生成器
    - 实现可配置的网格尺寸
    - 生成 XP 节点间的连接
    - _需求: 1.1, 1.4_

  - [x] 6.2 为网格拓扑编写属性测试
    - **属性 1: 2D Mesh 拓扑连接性**
    - **验证需求: Requirements 1.1, 1.4**

  - [x] 6.3 为死锁预防编写属性测试
    - **属性 3: 路由无死锁性**
    - **验证需求: Requirements 1.3**

- [-] 7. 实现 HN-F 一致性主节点
  - [x] 7.1 实现系统级缓存 (SLC)
    - 创建 16-way 组相联缓存结构
    - 实现缓存查找和替换算法
    - _需求: 4.2_

  - [x] 7.2 为 SLC 编写属性测试
    - **属性 9: 系统级缓存功能**
    - **验证需求: Requirements 4.2**

  - [x] 7.3 实现 Directory 管理器
    - 创建 Directory 表和状态管理
    - 实现状态查询和更新接口
    - _需求: 4.4, 7.1, 7.2_

  - [x] 7.4 实现 MESI 协议状态机
    - 编写缓存一致性状态转换逻辑
    - 处理各种一致性事件
    - _需求: 4.6_

  - [x] 7.5 为 MESI 状态机编写属性测试
    - **属性 12: MESI 状态机正确性**
    - **验证需求: Requirements 4.6**

  - [x] 7.6 实现监听过滤器
    - 创建 Snoop Filter 逻辑
    - 优化 snoop 请求的发送
    - _需求: 4.3, 4.5_

  - [x] 7.7 为监听过滤器编写属性测试
    - **属性 11: Snoop 过滤优化**
    - **验证需求: Requirements 4.3, 4.5, 7.5**

- [-] 8. 完成 HN-F 节点集成
  - [x] 8.1 集成 HN-F 顶层模块
    - 连接 SLC、Directory 和 Snoop Filter
    - 实现网络接口逻辑
    - _需求: 4.1, 4.2, 4.3_

  - [x] 8.2 编写 HN-F 集成测试
    - 测试完整的一致性流程
    - 验证组件间协作
    - _需求: 4.1, 4.2, 4.3, 4.4_

- [x] 9. 实现 RN-F 请求节点
  - [x] 9.1 实现本地缓存管理
    - 创建 L1 缓存结构
    - 实现缓存状态维护
    - _需求: 5.2_

  - [x] 9.2 实现 CPU 接口代理
    - 处理 CPU 读写请求
    - 转换为网络消息格式
    - _需求: 5.1, 5.4_

  - [x] 9.3 为 RN-F 代理功能编写属性测试
    - **属性 13: RN-F 代理功能**
    - **验证需求: Requirements 5.1, 5.4**

  - [x] 9.4 实现 Snoop 响应处理
    - 处理接收到的 snoop 请求
    - 生成正确的响应消息
    - _需求: 5.3_

  - [x] 9.5 为 Snoop 响应编写属性测试
    - **属性 14: Snoop 响应正确性**
    - **验证需求: Requirements 5.3**

  - [x] 9.6 实现写策略处理
    - 支持写回和写穿透策略
    - 处理脏数据管理
    - _需求: 5.5_

- [-] 10. 实现 SN-F 内存接口节点
  - [x] 10.1 实现内存控制器接口
    - 创建到 DDR/HBM 的接口转换
    - 处理内存访问协议转换
    - _需求: 6.1, 6.2_

  - [x] 10.2 为内存接口编写属性测试
    - **属性 15: 内存接口协议转换**
    - **验证需求: Requirements 6.1, 6.2**

  - [x] 10.3 实现多通道并行访问
    - 支持多个内存通道
    - 实现负载均衡和调度
    - _需求: 6.4_

  - [x] 10.4 为多通道访问编写属性测试
    - **属性 16: 多通道并行访问**
    - **验证需求: Requirements 6.4**

- [ ] 11. 检查点 - 验证各节点功能
  - 确保所有节点测试通过，如有问题请询问用户

- [ ] 12. 系统集成和顶层连接
  - [ ] 12.1 创建系统顶层模块
    - 实例化网格和各类节点
    - 建立节点间连接
    - _需求: 1.1, 1.4_

  - [ ] 12.2 实现系统配置接口
    - 支持网格尺寸配置
    - 节点类型和位置配置
    - _需求: 1.4_

  - [ ] 12.3 编写系统级集成测试
    - 测试端到端的数据流
    - 验证完整的一致性协议
    - _需求: 所有需求_

- [ ] 13. 错误处理和容错机制
  - [ ] 13.1 实现错误检测机制
    - 添加 CRC 校验和超时检测
    - 实现错误报告接口
    - _错误处理需求_

  - [ ] 13.2 实现重传和恢复机制
    - 支持错误 Flit 重传
    - 实现事务超时处理
    - _错误处理需求_

  - [ ] 13.3 编写错误处理测试
    - 测试各种错误情况
    - 验证恢复机制
    - _错误处理需求_

- [ ] 14. 最终检查点和验证
  - [ ] 14.1 运行完整的回归测试套件
    - 执行所有属性测试和单元测试
    - 验证系统功能完整性
    - _所有需求_

  - [ ] 14.2 性能基准测试
    - 测量吞吐量和延迟指标
    - 验证可扩展性
    - _性能需求_

  - [ ] 14.3 生成验证报告
    - 汇总测试结果和覆盖率
    - 记录已验证的功能特性
    - _文档需求_

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有测试任务都是必需的，确保从一开始就进行全面验证